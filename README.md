# Ewing Sarcoma scRNA-seq Pipeline (portable)

This folder is a portable copy of the pipeline with config-driven paths and write-safe outputs.
All generated files are written under `outputs/` by default so input directories can be read-only.

## Quick start
1) Edit `env/config.env` and set `FASTQ_ROOT` and `AMBIQUANT_REPO`.
2) Create environments (see `env/envs/`).
3) Run full pipeline (requires Cell Ranger installed and licensed):

```bash
./bin/run_all.sh
```

To skip Cell Ranger and run QC on an existing Cell Ranger output root:

```bash
./bin/run_all.sh --skip-cellranger --cellranger-root /path/to/cellranger_out --qc-out ./outputs/qc --config ./env/config.local.env
```

To prepare GEO GSE277083 primary-only matrix inputs for this pipeline (no FASTQs/BAMs):

```bash
./bin/prepare_geo_primary.sh --clean
./bin/run_all.sh --skip-cellranger --cellranger-root ./outputs/cellranger --qc-out ./outputs/qc --config ./env/config.local.env
```

Or to run only QC directly (recommended to use `env/config.local.env` if present):

```bash
./bin/pipeline_QC_after_cellranger.sh --root /path/to/cellranger_out --out ./outputs/qc --config ./env/config.local.env
```

If `env/config.local.env` exists, `run_all.sh` and `pipeline_QC_after_cellranger.sh`
will use it automatically. Prefer it over `env/config.env` because it pins the correct
`R_BIN`/`PYTHON_BIN` for your environment.

## Repo layout
- `bin/` entrypoints and orchestration scripts
- `scripts/` per-tool loop wrappers
- `r/` R analysis scripts
- `python/` Python utilities
- `resources/` static inputs (CellMarker, signatures, grouping rules, doublet tables)
- `env/` configs + conda/mamba environment files
- `docs/` tutorials and walkthroughs (see `docs/pipeline_tutorial_minimal.md`)

## One-command setup (recommended on a new machine)
This creates/updates the Python + R environments, installs GitHub-only R packages,
and writes `env/config.local.env` with the correct `R_BIN`/`PYTHON_BIN` paths.

```bash
./bin/setup_envs.sh
```

To pre-install Azimuth references (large downloads), run:

```bash
./bin/setup_envs.sh --install-azimuth-refs --azimuth-refs lungref,liverref
```

## Output layout (default)
- `outputs/refdata/` Cell Ranger reference
- `outputs/cellranger/` Cell Ranger per-sample outputs
- `outputs/qc/` QC outputs (EmptyDrops, Seurat metadata, SoupX, DoubletFinder, DropletQC, AmbiQuant, Seurat QC)
- `outputs/annotation_integration/` Annotation + integration outputs

## Matrix-only inputs (no FASTQs/BAMs)
If you start from matrices only (e.g., GEO), you can skip Cell Ranger and DropletQC.
Example for GSE277083 primary-only inputs:

```bash
./bin/prepare_geo_primary.sh --clean
./bin/run_all.sh --skip-cellranger --cellranger-root ./outputs/cellranger --qc-out ./outputs/qc --config ./env/config.local.env
```

Also set in `env/config.local.env`:
- `SEURAT_FINAL_REQUIRE_DROPLETQC=false`

## Environments
This pipeline uses separate Python and R environments, and a separate AmbiQuant repo/venv.

### Python (AmbiQuant + QC utilities)
Create the Python environment from `env/envs/python.yml`:

```bash
mamba env create -f env/envs/python.yml
mamba activate ewing-scrna-py
```

### R (SoupX, Seurat, DropletQC, DoubletFinder)
Create the R environment from `env/envs/r.yml`:

```bash
mamba env create -f env/envs/r.yml
mamba activate ewing-scrna-r
```

If any R packages are missing after env creation, install them from R (Bioconductor or GitHub).

#### GitHub-only R packages (required)
These are not guaranteed to be available via conda/Bioconductor. Install them in the R env:

```bash
mamba activate ewing-scrna-r
Rscript -e "if (!requireNamespace('remotes', quietly=TRUE)) install.packages('remotes', repos='https://cloud.r-project.org'); remotes::install_github('chris-mcginnis-ucsf/DoubletFinder'); remotes::install_github('powellgenomicslab/DropletQC')"
```

### AmbiQuant (optional but recommended)
Clone the AmbiQuant repo and set `AMBIQUANT_REPO` in `env/config.env`. If you use a micromamba/conda env,
set `AMBIQUANT_ENV` and `MICROMAMBA_BIN` as well. If `AMBIQUANT_REPO` is empty, AmbiQuant steps are skipped.

## Notes
- Cell Ranger is proprietary software and must be installed and licensed separately by each user.
  `run_all.sh` runs Cell Ranger unless you pass `--skip-cellranger`.
- Cell Ranger intron counting is configurable via `CELLRANGER_INCLUDE_INTRONS`
  (set `true` for snRNA-seq, `false` for scRNA-seq).
- Reference download uses `wget` and internet access.
- Optional integrity check: set `REF_TGZ_SHA256` in `env/config.env` to verify the 10x reference tarball.
- All outputs are written under `outputs/` by default; no writes are performed inside the input sample directories.
- If you want custom paths, edit `env/config.env` or pass `--config`.
- SoupX metadata is generated by a minimal Seurat clustering step unless you provide a precomputed `metadata.csv`.
  If only one cluster is detected, the script retries at higher resolution before falling back to a default rho.
  The metadata must include all barcodes in the filtered matrix (no pre-filtering) and a `leiden` column.
- Final subsetting + normalization/clustering is done in Seurat (`r/Seurat_final_subsetting.R`), not in Python.
  Set `SEURAT_FINAL_REGRESS=true` to enable SCTransform regression on `percent.mt`, `percent.rps`, `percent.rpl`.
- Cell cycle scoring uses Seurat's built-in `cc.genes.updated.2019`.
  Set `SEURAT_FINAL_REGRESS_CELL_CYCLE=true` to regress out `S.Score` and `G2M.Score`.
- DoubletFinder rate: set `DOUBLETFINDER_RATE=auto` to derive rates from Cell Ranger metrics
  (uses `doublet_rate_table_v3.csv` when chemistry is unknown). You can override with a numeric rate.
  Set `DOUBLETFINDER_CHEMISTRY` to pick a built-in table (supported: `3p_v3`, `3p_v3p1`, `3p_v4`,
  `3p_ht_v3p1`, `5p_v2`). You can also set `DOUBLETFINDER_RATE_TABLE` to a custom CSV with `n_cells,rate`.
  DoubletFinder reproducibility: set `DOUBLETFINDER_SEED` to control the RNG seed (default: 1).
- Final QC thresholds: set `SEURAT_FINAL_MAX_PERCENT_MT` and `SEURAT_FINAL_MAX_PERCENT_RIBO` to filter cells
  by mitochondrial and ribosomal content. Set `SEURAT_FINAL_BASIC_MIN_FEATURES` to align the basic QC gate
  with DoubletFinder (defaults to `DOUBLETFINDER_MIN_FEATURES` if unset).
- DropletQC uses Leiden clusters from `outputs/qc/seurat_metadata/<sample>/metadata.csv` when available
  (falls back to a single `cell_type=all` group). DropletQC requires `possorted_genome_bam.bam`; if you start
  from matrix-only inputs (no BAMs), set `SEURAT_FINAL_REQUIRE_DROPLETQC=false` in `env/config.local.env`.
- CellMarker2.0 + Azimuth annotation: the pipeline reads CellMarker2.0 directly from
  `CELL_MARKER_XLSX` (default `resources/Cell_marker_Seq_human.xlsx`), optionally filters by
  `CELL_MARKER_TISSUES` (comma list or file path), then computes AddModuleScore per sample.
  The Ewing sarcoma signature is loaded from `EWING_SIGNATURE_CSV` (default `resources/Aynaud.csv`).
  Azimuth references are run per sample (default: pbmcref, bonemarrowref, lungref, adiposeref, fetusref, liverref).
  To regenerate the Azimuth label catalog used for pattern curation, run:
  `Rscript r/Azimuth_label_catalog.R resources/azimuth_label_catalog.txt pbmcref,bonemarrowref,lungref,adiposeref,fetusref,liverref`.
  The grouping rules live in `resources/celltype_grouping_rules.csv`; regenerate `resources/celltype_grouping.txt` via:
  `Rscript r/build_celltype_grouping.R resources/celltype_grouping_rules.csv`.
  Outputs include:
  - `outputs/annotation_integration/seurat_annotation_integration/merged_annotations.csv` (per-cell module and Azimuth scores)
  - `outputs/annotation_integration/seurat_annotation_integration/celltype_assignment_by_cluster.csv` (cluster-level assignment summary)
  - `outputs/annotation_integration/seurat_annotation_integration/cellmarker_modules_map.csv` (module index â†’ name map)
  - `outputs/annotation_integration/seurat_annotation_integration/umap_pre/` (merged UMAPs by sample/cell type)
  - `outputs/annotation_integration/seurat_annotation_integration/featureplots_samples/<sample>/` (module + EWING feature plots on merged UMAP)
  - `outputs/annotation_integration/seurat_annotation_integration/featureplots_celltypes_samples/<sample>/` (per-celltype highlight plots)
  Annotation combines percentile-based Azimuth and module evidence, with a tumor-priority
  override when Ewing signature is strong alongside neuronal/fetal programs.

## Reproducible environments (lock files)
We provide pinned exports in `env/envs/python.lock.yml` and `env/envs/r.lock.yml` generated from a working install.
These are OS-specific but useful for reproducing exact versions.

```bash
micromamba create -n ewing-scrna-py -f env/envs/python.lock.yml
micromamba create -n ewing-scrna-r -f env/envs/r.lock.yml
```
